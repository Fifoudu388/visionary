<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visionary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#0f172a',
                        'secondary-dark': '#1e293b',
                        'accent': '#3b82f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
        }
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .poster-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .poster-card.playable:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }
        .poster-card.unplayable {
            opacity: 0.6;
            filter: grayscale(80%);
            cursor: default;
        }
        .poster-image {
            aspect-ratio: 2 / 3;
            object-fit: cover;
        }
        .modal-container {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #60a5fa; }
    </style>

    <!-- Script PostHog principal -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('phc_d37GZTIHfAUgHbsLqUNypv71jOb23WvlTqIttNP0DmF', {
            api_host: 'https://us.i.posthog.com',
            defaults: '2025-11-30',
            person_profiles: 'identified_only',
        })
    </script>

    <!-- Script PostHog pour le suivi des erreurs -->
    <script>
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
        posthog.init('phc_d37GZTIHfAUgHbsLqUNypv71jOb23WvlTqIttNP0DmF',{api_host:'https://us.i.posthog.com', defaults:'2025-11-30'})
    </script>

    <!-- Gestionnaire d'erreurs global avec notification utilisateur -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            if (window.posthog) {
                posthog.captureException(error, {
                    message: message,
                    source: source,
                    line: lineno,
                    column: colno,
                    level: 'error',
                    environment: 'production'
                });
            }

            displayMessage(
                "Une erreur est survenue et a √©t√© signal√©e. Nous travaillons pour la corriger. Merci de votre patience.",
                'error'
            );

            console.error("Erreur remont√©e :", {
                message: message,
                source: source,
                line: lineno,
                column: colno,
                stack: error ? error.stack : 'Pas de stack trace'
            });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            if (window.posthog) {
                posthog.captureException(event.reason, {
                    type: 'unhandled_rejection',
                    reason: event.reason,
                    level: 'error',
                    environment: 'production'
                });
            }

            displayMessage(
                "Une erreur inattendue est survenue et a √©t√© signal√©e. Veuillez rafra√Æchir la page ou r√©essayer plus tard.",
                'error'
            );

            console.error("Unhandled rejection :", event.reason);
        });
    </script>
</head>
<!-- Bouton pour d√©clencher une erreur (visible uniquement en mode d√©veloppement) -->
<div id="errorTestButton"
     class="fixed bottom-4 right-4 z-50 flex flex-col space-y-2"
     style="display: none;">
    <button onclick="triggerSyncError()"
            class="p-3 bg-red-600 text-white rounded-lg shadow-lg hover:bg-red-700 transition">
        Tester une erreur synchrone
    </button>
    <button onclick="triggerAsyncError()"
            class="p-3 bg-purple-600 text-white rounded-lg shadow-lg hover:bg-purple-700 transition">
        Tester une erreur asynchrone
    </button>
    <button onclick="toggleErrorButton()"
            class="p-2 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition text-sm">
        Masquer
    </button>
</div>

<script>
    // Fonction pour afficher/masquer le bouton (activez avec Ctrl+Alt+E)
    function toggleErrorButton() {
        const button = document.getElementById('errorTestButton');
        button.style.display = button.style.display === 'none' ? 'flex' : 'none';
    }

    // Fonction pour d√©clencher une erreur synchrone
    function triggerSyncError() {
        throw new Error("‚ö†Ô∏è Erreur de test synchrone d√©clench√©e manuellement !");
    }

    // Fonction pour d√©clencher une erreur asynchrone
    function triggerAsyncError() {
        Promise.reject(new Error("‚ö†Ô∏è Erreur de test asynchrone d√©clench√©e manuellement !"));
    }

    // Raccourci clavier pour afficher le bouton (Ctrl+Alt+E)
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.altKey && e.key === 'e') {
            toggleErrorButton();
        }
    });

    // Affiche le bouton si l'URL contient ?test_error=true
    if (window.location.search.includes('test_error=true')) {
        toggleErrorButton();
    }
</script>


<body class="font-sans">

    <header class="bg-secondary-dark shadow-lg sticky top-0 z-10 p-4 md:p-6">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <h1 class="text-3xl font-bold text-accent tracking-wider">Visionary</h1>

            <div class="flex flex-wrap justify-center gap-3 w-full md:w-auto">
                <div class="relative w-full sm:w-64">
                    <input type="text" id="searchInput" placeholder="Rechercher par titre..." class="w-full p-2 pl-10 rounded-lg bg-primary-dark border border-secondary-dark focus:border-accent focus:ring-1 focus:ring-accent text-sm transition" oninput="filterMovies(this.value)">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>

                <button id="toggleViewBtn" class="p-2 rounded-lg bg-accent hover:bg-blue-600 transition text-sm font-semibold flex items-center shadow-md" onclick="toggleViewMode()">
                    <svg id="viewIcon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span>Mode Grille</span>
                </button>

                <select id="sortSelect" class="p-2 rounded-lg bg-primary-dark border border-secondary-dark focus:border-accent focus:ring-1 focus:ring-accent text-sm transition" onchange="sortMovies()">
                    <option value="rating">Trier par Note</option>
                    <option value="alpha">Trier par Ordre Alphab√©tique</option>
                    <option value="date">Trier par Date d'Ajout</option>
                </select>

                <select id="autoReloadSelect" class="p-2 rounded-lg bg-primary-dark border border-secondary-dark focus:border-accent focus:ring-1 focus:ring-accent text-sm transition" onchange="setupAutoReload()">
                    <option value="0">Rechargement d√©sactiv√©</option>
                    <option value="30000">Recharger toutes les 30s</option>
                    <option value="60000">Recharger toutes les 60s</option>
                    <option value="300000">Recharger toutes les 5m</option>
                </select>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6">
        <div id="messageArea" class="py-4">
            <div id="loadingMessage" class="flex items-center text-accent">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                Chargement des films depuis films.txt...
            </div>
        </div>

        <div id="moviesContainer" class="min-h-[50vh]"></div>
    </main>

    <div id="playerModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden modal-container p-4 overflow-y-auto" onclick="closeModal(event)">
        <div class="relative max-w-4xl mx-auto bg-secondary-dark rounded-xl shadow-2xl p-4 md:p-8 modal-content" onclick="event.stopPropagation()">
            <button class="absolute top-4 right-4 text-gray-300 hover:text-accent transition" onclick="closeModal()">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <h2 id="modalTitle" class="text-3xl font-bold text-white mb-4 pr-10">Titre du Film</h2>

            <div class="aspect-video bg-primary-dark rounded-lg overflow-hidden mb-6">
                <iframe id="videoPlayer" class="w-full h-full" src=""
                        allow="autoplay; fullscreen; encrypted-media" 
                        frameborder="0" 
                        referrerpolicy="no-referrer" 
                        allowfullscreen></iframe>
            </div>

            <p id="modalDescription" class="text-gray-300 mb-4"></p>

            <a id="modalExternalLink" href="#" target="_blank" class="inline-flex items-center text-accent hover:text-blue-400 transition font-semibold text-sm">
                Ouvrir le lecteur dans un nouvel onglet
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            </a>
        </div>
    </div>

    <script>
        const TMDB_API_KEY = 'cc8c196133c6efa48fd2edc1e20967a7';
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3/movie/';
        const TMDB_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/';
        const TMDB_LANGUAGE = 'fr-FR';

        let moviesData = [];
        let currentViewMode = 'grid';
        let reloadIntervalId = null;
        let currentSortMode = 'rating';
        let movieInsertionOrder = [];

        const moviesContainer = document.getElementById('moviesContainer');
        const messageArea = document.getElementById('messageArea');
        const searchInput = document.getElementById('searchInput');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const viewIcon = document.getElementById('viewIcon');
        const playerModal = document.getElementById('playerModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const modalTitle = document.getElementById('modalTitle');
        const modalDescription = document.getElementById('modalDescription');
        const modalExternalLink = document.getElementById('modalExternalLink');

        function sanitizeUrl(str) {
            if (!str) return '';
            return str.replace(/[\u200B-\u200F\uFEFF\u00AD\t\n\r]/g, '').trim();
        }

        function extractEmbedUrl(url) {
            if (!url || typeof url !== 'string' || url === '') {
                return null;
            }

            if (url.includes('zupload.cc/embed/')) {
                const match = url.match(/https:\/\/zupload\.cc\/embed\/([a-zA-Z0-9_-]+)/);
                if (match) {
                    return `https://zupload.cc/embed/${match[1]}`;
                }
            }

            if (url.includes('uqload.cx/embed-')) {
                const match = url.match(/https:\/\/uqload\.cx\/embed-([a-zA-Z0-9_-]+)\.html/);
                if (match) {
                    return `https://uqload.cx/embed-${match[1]}.html`;
                }
            }

            console.warn(`Format d'URL non reconnu: ${url}`);
            return null;
        }

        function displayMessage(message, type = 'info') {
            let bgColor, textColor, icon;
            messageArea.classList.remove('hidden');

            switch (type) {
                case 'loading':
                    bgColor = 'bg-secondary-dark';
                    textColor = 'text-accent';
                    icon = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
                    break;
                case 'error':
                    bgColor = 'bg-red-900/50';
                    textColor = 'text-red-400';
                    icon = '<svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    break;
                case 'success':
                    bgColor = 'bg-green-900/50';
                    textColor = 'text-green-400';
                    icon = '<svg class="h-5 w-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                    break;
                default:
                    bgColor = 'bg-secondary-dark';
                    textColor = 'text-gray-300';
                    icon = '';
            }

            messageArea.innerHTML = `
                <div class="${bgColor} ${textColor} p-4 rounded-xl shadow-lg flex items-center mb-4 transition duration-500 fade-in">
                    ${icon}
                    <p>${message}</p>
                </div>
            `;
        }

        function displayTempMessage(message, type, duration = 3000) {
            displayMessage(message, type);
            setTimeout(() => { 
                messageArea.innerHTML = ''; 
                messageArea.classList.add('hidden');
            }, duration);
        }

        async function loadMovieIds() {
            try {
                const response = await fetch('films.txt', { cache: 'no-cache' });
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}. V√©rifiez le nom du fichier.`);
                }
                const text = await response.text();
                
                const lines = text.split('\n');
                const rawMovies = [];

                lines.forEach(line => {
                    const cleanLine = line.replace(/^\uFEFF/, '').trim().replace(/[\r\n]/g, '');
                    
                    if (cleanLine === '' || cleanLine.startsWith('#')) {
                        return;
                    }

                    const parts = cleanLine.split(';').map(p => p.trim());
                    
                    if (parts.length >= 1 && parts[0] !== '') {
                        const tmdbId = parts[0];
                        const videoUrls = parts.slice(1).map(url => sanitizeUrl(url)).filter(url => url !== '');
                        
                        if (videoUrls.length > 0) {
                            console.log(`ID ${tmdbId} charg√© avec ${videoUrls.length} URL(s)`);
                        } else {
                            console.warn(`ID ${tmdbId} sans URL de streaming`);
                        }

                        rawMovies.push({ tmdbId, videoUrls });
                    }
                });
                
                return rawMovies;

            } catch (error) {
                console.error("Erreur lors du chargement de films.txt:", error);
                displayMessage(`Impossible de charger films.txt. D√©tail: ${error.message}`, 'error');
                return [];
            }
        }

        async function fetchTmdbData(tmdbId) {
            const url = `${TMDB_BASE_URL}${tmdbId}?api_key=${TMDB_API_KEY}&language=${TMDB_LANGUAGE}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Film TMDB ID ${tmdbId} introuvable (Status: ${response.status})`);
                }
                const data = await response.json();

                return {
                    id: tmdbId,
                    title: data.title,
                    overview: data.overview || 'Description non disponible en fran√ßais.',
                    posterPath: data.poster_path,
                    releaseYear: data.release_date ? new Date(data.release_date).getFullYear() : 'N/A',
                    voteAverage: data.vote_average ? data.vote_average.toFixed(1) : 'N/A',
                };
            } catch (error) {
                console.warn(error.message);
                return null;
            }
        }

        async function loadAllMovies() {
            moviesContainer.innerHTML = '';
            displayMessage("Chargement des films depuis films.txt...", 'loading');
            
            const rawMovies = await loadMovieIds();

            if (rawMovies.length === 0 && messageArea.innerHTML.includes('Impossible de charger')) {
                return;
            }

            const tmdbPromises = rawMovies.map(async (rawMovie) => {
                const tmdbData = await fetchTmdbData(rawMovie.tmdbId);
                if (tmdbData) {
                    return { ...tmdbData, videoUrls: rawMovie.videoUrls };
                }
                return null;
            });

            const results = await Promise.all(tmdbPromises);
            moviesData = results.filter(movie => movie !== null);
            
            // Enregistrer l'ordre d'insertion (ordre du fichier films.txt)
            movieInsertionOrder = moviesData.map((movie, index) => ({
                id: movie.id,
                order: index
            }));

            messageArea.innerHTML = '';

            if (moviesData.length > 0) {
                sortMovies(); // Applique le tri actuel
                displayTempMessage(`Chargement termin√© : ${moviesData.length} films affich√©s.`, 'success');
            } else if (rawMovies.length > 0) {
                displayMessage(`Aucun film TMDB n'a pu √™tre charg√©. ${rawMovies.length} ID TMDB(s) non trouv√©s ou erreur API.`, 'error');
            } else {
                displayMessage("Le fichier films.txt a √©t√© trouv√©, mais ne contient aucune entr√©e de film valide.", 'error');
            }
        }

        function renderGridMovie(movie) {
            const posterUrl = movie.posterPath 
                ? `${TMDB_IMAGE_BASE_URL}w500${movie.posterPath}` 
                : 'https://placehold.co/500x750/1e293b/f8fafc?text=Affiche+Manquante';
            
            const url0 = movie.videoUrls[0] || '';
            const url1 = movie.videoUrls[1] || '';
            
            const isPlayable = !!url0 || !!url1;
            const playableClass = isPlayable ? 'playable hover:ring-2 hover:ring-accent' : 'unplayable';
            const clickHandler = isPlayable ? 'openModal(this)' : 'displayTempMessage(\'URL de streaming manquante. Film non-jouable.\', \'error\', 2000)';

            return `
                <div class="poster-card rounded-xl overflow-hidden bg-secondary-dark ${playableClass} fade-in" 
                     style="animation-delay: ${Math.random() * 0.2}s;"
                     onclick="${clickHandler}"
                     data-title="${movie.title}"
                     data-description="${movie.overview}"
                     data-url-0="${url0}"
                     data-url-1="${url1}">
                    
                    ${!isPlayable ? '<div class="absolute top-0 left-0 bg-red-700/80 text-white text-xs font-bold p-1 rounded-br-lg z-10">URL MANQUANTE</div>' : ''}
                    
                    <img src="${posterUrl}" alt="Affiche de ${movie.title}" class="poster-image w-full"
                        onerror="this.onerror=null;this.src='https://placehold.co/500x750/1e293b/f8fafc?text=Affiche+Manquante';">
                    
                    <div class="p-3">
                        <h3 class="text-white font-semibold truncate">${movie.title}</h3>
                        <p class="text-xs text-gray-400">(${movie.releaseYear}) - ${movie.voteAverage}/10</p>
                    </div>
                </div>
            `;
        }

        function renderListMovie(movie) {
            const posterUrl = movie.posterPath 
                ? `${TMDB_IMAGE_BASE_URL}w200${movie.posterPath}` 
                : 'https://placehold.co/100x150/1e293b/f8fafc?text=N/A';
            
            const url0 = movie.videoUrls[0] || '';
            const url1 = movie.videoUrls[1] || '';
            
            const isPlayable = !!url0 || !!url1;
            const playableClass = isPlayable ? 'hover:bg-slate-700' : 'unplayable opacity-60';
            const clickHandler = isPlayable ? 'openModal(this)' : 'displayTempMessage(\'URL de streaming manquante. Film non-jouable.\', \'error\', 2000)';

            return `
                <div class="flex bg-secondary-dark rounded-xl shadow-lg mb-4 p-4 items-start transition fade-in ${playableClass}" 
                     style="animation-delay: ${Math.random() * 0.1}s;">
                    
                    <img src="${posterUrl}" alt="Affiche de ${movie.title}" class="w-16 h-24 object-cover rounded-md flex-shrink-0 mr-4"
                         onerror="this.onerror=null;this.src='https://placehold.co/100x150/1e293b/f8fafc?text=N/A';">
                    
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-white mb-1">${movie.title} <span class="text-sm font-normal text-gray-400">(${movie.releaseYear})</span></h3>
                        <p class="text-sm text-gray-300 mb-2 line-clamp-2">${movie.overview}</p>
                        
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-amber-400">‚≠ê ${movie.voteAverage}/10</p>
                            <button class="px-4 py-2 rounded-lg text-white font-semibold transition shadow-md text-sm
                                    ${isPlayable ? 'bg-accent hover:bg-blue-600' : 'bg-gray-500 cursor-not-allowed'}"
                                    onclick="${clickHandler}"
                                    data-title="${movie.title}"
                                    data-description="${movie.overview}"
                                    data-url-0="${url0}"
                                    data-url-1="${url1}"
                                    ${!isPlayable ? 'disabled' : ''}>
                                ${isPlayable ? 'Regarder' : 'Non disponible'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMovies(movies) {
            moviesContainer.innerHTML = '';
            
            if (movies.length === 0) {
                moviesContainer.innerHTML = `
                    <p class="text-center text-gray-400 text-lg mt-10">Aucun film ne correspond √† votre recherche.</p>
                `;
                return;
            }

            if (currentViewMode === 'grid') {
                moviesContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6';
                movies.forEach(movie => {
                    moviesContainer.innerHTML += renderGridMovie(movie);
                });
            } else {
                moviesContainer.className = 'flex flex-col space-y-4';
                movies.forEach(movie => {
                    moviesContainer.innerHTML += renderListMovie(movie);
                });
            }
        }

        function toggleViewMode() {
            currentViewMode = currentViewMode === 'grid' ? 'list' : 'grid';
            
            const pathGrid = 'M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z';
            const pathList = 'M4 6h16M4 10h16M4 14h16M4 18h16';

            if (currentViewMode === 'grid') {
                viewIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${pathGrid}"></path>`;
                toggleViewBtn.querySelector('span').textContent = 'Mode Grille';
            } else {
                viewIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${pathList}"></path>`;
                toggleViewBtn.querySelector('span').textContent = 'Mode Liste';
            }
            
            renderMovies(moviesData);
        }

        function sortMovies() {
            currentSortMode = document.getElementById('sortSelect').value;
            
            let sortedMovies = [...moviesData];
            
            switch(currentSortMode) {
                case 'alpha':
                    sortedMovies.sort((a, b) => a.title.localeCompare(b.title, 'fr'));
                    break;
                case 'date':
                    // Tri par ordre d'apparition dans le fichier films.txt
                    sortedMovies.sort((a, b) => {
                        const orderA = movieInsertionOrder.find(m => m.id === a.id)?.order ?? 999999;
                        const orderB = movieInsertionOrder.find(m => m.id === b.id)?.order ?? 999999;
                        return orderA - orderB;
                    });
                    break;
                case 'rating':
                default:
                    sortedMovies.sort((a, b) => b.voteAverage - a.voteAverage);
                    break;
            }
            
            renderMovies(sortedMovies);
        }

        function filterMovies(query) {
            const lowerCaseQuery = query.toLowerCase().trim()
                .replace(/[-_]/g, ' ') // Remplace tirets et underscores par espaces
                .replace(/\s+/g, ' '); // Normalise les espaces multiples
            
            const filteredMovies = moviesData.filter(movie => {
                const normalizedTitle = movie.title.toLowerCase()
                    .replace(/[-_]/g, ' ')
                    .replace(/\s+/g, ' ');
                return normalizedTitle.includes(lowerCaseQuery);
            });
            renderMovies(filteredMovies);
        }

        function openModal(element) {
            const title = element.getAttribute('data-title');
            const originalDescription = element.getAttribute('data-description');
            
            const videoUrl0 = element.getAttribute('data-url-0') || '';
            const videoUrl1 = element.getAttribute('data-url-1') || '';
            
            console.log("--- D√âBOGAGE openModal ---");
            console.log(`URL 0: "${videoUrl0}"`);
            console.log(`URL 1: "${videoUrl1}"`);

            let finalEmbedUrl = extractEmbedUrl(videoUrl0);

            if (!finalEmbedUrl && videoUrl1) {
                console.log(`Tentative avec URL secondaire: ${videoUrl1}`);
                finalEmbedUrl = extractEmbedUrl(videoUrl1);
            }

            modalTitle.textContent = title;
            
            let displayDescription = originalDescription;
            let showExternalLink = false;
            
            if (finalEmbedUrl) {
                console.log(`Chargement iframe: ${finalEmbedUrl}`);
                
                videoPlayer.src = finalEmbedUrl;
                modalExternalLink.href = finalEmbedUrl;
                showExternalLink = true;
            } else {
                videoPlayer.src = '';
                
                console.error(`√âCHEC: Impossible de g√©n√©rer l'URL d'embed pour "${title}"`);
                console.log(`URLs re√ßues: [0] = "${videoUrl0}", [1] = "${videoUrl1}"`);

                displayDescription = originalDescription + "\n\nüö® ATTENTION: Aucune URL de streaming valide (Zupload ou Uqload) d√©tect√©e. V√©rifiez le fichier films.txt.";
                showExternalLink = false;
            }
            
            modalDescription.textContent = displayDescription;

            if (showExternalLink) {
                modalExternalLink.classList.remove('hidden');
            } else {
                modalExternalLink.classList.add('hidden');
            }

            playerModal.classList.remove('hidden');
        }

        function closeModal(event) {
            if (event && event.target.id !== 'playerModal') return;

            videoPlayer.src = '';
            playerModal.classList.add('hidden');
        }

        function setupAutoReload() {
            if (reloadIntervalId) {
                clearInterval(reloadIntervalId);
                reloadIntervalId = null;
            }

            const intervalMs = parseInt(document.getElementById('autoReloadSelect').value, 10);

            if (intervalMs > 0) {
                reloadIntervalId = setInterval(() => {
                    console.log(`Rechargement automatique (${intervalMs / 1000}s)...`);
                    loadAllMovies();
                }, intervalMs);
                displayTempMessage(`Rechargement automatique activ√© : toutes les ${intervalMs / 1000} secondes.`, 'info');
            } else {
                displayTempMessage('Rechargement automatique d√©sactiv√©.', 'info');
            }
        }

        document.addEventListener('DOMContentLoaded', loadAllMovies);
    </script>
</body>
</html>