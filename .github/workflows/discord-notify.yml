name: Discord Notifications

on:
  push:
  pull_request:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # RÃ©cupÃ©ration du dÃ©pÃ´t
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # PrÃ©paration des donnÃ©es
      - name: Prepare Data
        id: prep
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          ROLE_ID="123456789012345678"  # Remplace par ton rÃ´le Discord
          TS=$(date +%s)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          VERSION="v-$SHORT_SHA"

          # Type de commit
          COMMIT_MSG=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[0].message')
          COMMIT_TYPE=$(echo "$COMMIT_MSG" | grep -Eo '^(feat|fix|docs|style|refactor|perf|test|chore)' || echo "update")

          # Couleur et emoji selon le type
          case "$COMMIT_TYPE" in
            feat) COLOR=3066993; EMOJI="ðŸš€";;
            fix) COLOR=15158332; EMOJI="ðŸ›";;
            docs) COLOR=10181046; EMOJI="ðŸ“";;
            *) COLOR=3447003; EMOJI="ðŸ“¦";;
          esac

          # Auteur du commit
          COMMIT_AUTHOR_NAME=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[0].author.name')
          COMMIT_AUTHOR_URL="https://github.com/${{ github.event.commits[0].author.username }}"

          # Liste des commits
          COMMITS=$(echo '${{ toJson(github.event.commits) }}' | jq -r '.[] | "â€¢ **\(.id[0:7])** â€” \(.message)"' | paste -sd "\\n" -)

          # Lien vers la PR (si c'est une PR)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_LINK="[Pull Request #${{ github.event.number }}](https://github.com/${{ github.repository }}/pull/${{ github.event.number }})"
          else
            PR_LINK="Aucune"
          fi

          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author_name=$COMMIT_AUTHOR_NAME" >> $GITHUB_OUTPUT
          echo "author_url=$COMMIT_AUTHOR_URL" >> $GITHUB_OUTPUT
          echo "pr_link=$PR_LINK" >> $GITHUB_OUTPUT
          echo "short=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "role=$ROLE_ID" >> $GITHUB_OUTPUT

      # Envoi de la notification Discord
      - name: Send Discord Message
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          AVATAR_URL: "https://avatars.githubusercontent.com/u/XXXXX?s=400"  # Remplace XXXXX
        run: |
          cat <<EOF > payload.json
          {
            "content": "<@&${{ steps.prep.outputs.role }}>",
            "embeds": [
              {
                "title": "${{ steps.prep.outputs.emoji }} Nouvel Ã©vÃ©nement sur ${{ steps.prep.outputs.repo }}",
                "url": "https://github.com/${{ steps.prep.outputs.repo }}",
                "color": ${{ steps.prep.outputs.color }},
                "author": {
                  "name": "${{ steps.prep.outputs.author_name }}",
                  "url": "${{ steps.prep.outputs.author_url }}",
                  "icon_url": "$AVATAR_URL"
                },
                "fields": [
                  {
                    "name": "Type",
                    "value": "\`${{ steps.prep.outputs.type }}\`",
                    "inline": true
                  },
                  {
                    "name": "Version",
                    "value": "\`${{ steps.prep.outputs.version }}\`",
                    "inline": true
                  },
                  {
                    "name": "Branche",
                    "value": "\`${{ steps.prep.outputs.branch }}\`",
                    "inline": true
                  },
                  {
                    "name": "SHA",
                    "value": "[\`${{ steps.prep.outputs.short }}\`](https://github.com/${{ steps.prep.outputs.repo }}/commit/${{ steps.prep.outputs.short }})",
                    "inline": true
                  },
                  {
                    "name": "Pull Request",
                    "value": "${{ steps.prep.outputs.pr_link }}"
                  },
                  {
                    "name": "Changelog",
                    "value": "${{ steps.prep.outputs.commits }}"
                  }
                ],
                "footer": {
                  "text": "GitHub Actions â€¢ Aujourdâ€™hui Ã  $(date -u +"%H:%M")"
                },
                "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              }
            ]
          }
          EOF

          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               $DISCORD_WEBHOOK
