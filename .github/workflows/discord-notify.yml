name: Discord Notifications

on:
  push:
  pull_request:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # RÃ©cupÃ©ration du repo
      - name: Checkout
        uses: actions/checkout@v4

      ##############################################################
      # 1. Calcule : commits, type, version, timestamp, etc.
      ##############################################################
      - name: Prepare Data
        id: prep
        run: |
          # TOUTES LES DONNÃ‰ES IMPORTANTES
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          ROLE_ID="123456789012345678"    # <--- MET TON RÃ”LE ICI

          # Timestamp UNIX
          TS=$(date +%s)

          # Version basÃ©e sur SHA court
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          VERSION="v-$SHORT_SHA"

          # Type de commit basÃ© sur le message (feat, fix, docsâ€¦)
          COMMIT_TYPE=$(echo "${{ github.event.head_commit.message }}" | grep -Eo '^(feat|fix|docs|style|refactor|perf|test|chore)' || echo "update")

          # Couleur selon type
          case "$COMMIT_TYPE" in
            feat) COLOR=3066993 ;;     # vert
            fix) COLOR=15158332 ;;     # rouge
            docs) COLOR=10181046 ;;    # bleu
            *) COLOR=3447003 ;;        # bleu par dÃ©faut
          esac

          # Compte total de commits
          TOTAL_COMMITS=$(git rev-list --count HEAD)

          # Construire la liste des commits du push
          COMMITS=""
          for c in $(echo "${{ github.event.commits[*].id }}"); do
            MSG=$(jq -r ".commits[] | select(.id==\"$c\").message" <<< "${{ toJson(github.event) }}")
            SHORT=$(echo "$c" | cut -c1-7)
            COMMITS="$COMMITS\nâ€¢ **$SHORT** â€” $MSG"
          done

          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "type=$COMMIT_TYPE" >> $GITHUB_OUTPUT
          echo "short=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$TS" >> $GITHUB_OUTPUT
          echo "role=$ROLE_ID" >> $GITHUB_OUTPUT

      ##############################################################
      # 12. GÃ©nÃ©ration automatique du CHANGELOG.md
      ##############################################################
      - name: Generate Changelog
        run: |
          echo "## Version ${{ steps.prep.outputs.version }}" > CHANGELOG.md
          echo "Date : <t:${{ steps.prep.outputs.timestamp }}:f>" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Commits inclus :" >> CHANGELOG.md
          echo -e "${{ steps.prep.outputs.commits }}" >> CHANGELOG.md

      ##############################################################
      # 9/14. Message spÃ©cial si branche = main
      ##############################################################
      - name: Custom Message for Main
        if: ${{ steps.prep.outputs.branch == 'main' }}
        run: echo "ðŸš€ DÃ©ploiement en cours sur la branche *main* !"

      ##############################################################
      # ENVOI DISCORD (Push + PR)
      ##############################################################
      - name: Send Discord Message
        run: |
          # Construction du contenu propre
          TITLE="ðŸ“Œ Nouvel Ã©vÃ©nement GitHub sur ${{ steps.prep.outputs.repo }}"
          DESCRIPTION="**Type :** ${{ steps.prep.outputs.type }}  
          **Version :** ${{ steps.prep.outputs.version }}  
          **Total commits :** ${{ steps.prep.outputs.total }}  
          
          **Commits inclus :**
          ${{ steps.prep.outputs.commits }}"

          # Embed Discord
          cat <<EOF > payload.json
          {
            "content": "<@&${{ steps.prep.outputs.role }}>",
            "embeds": [{
              "title": "$TITLE",
              "description": "$DESCRIPTION",
              "color": ${{ steps.prep.outputs.color }},
              "fields": [
                { "name": "Branche", "value": "${{ steps.prep.outputs.branch }}", "inline": true },
                { "name": "SHA", "value": "${{ steps.prep.outputs.short }}", "inline": true }
              ],
              "footer": { "text": "GitHub Actions â€¢ Event" },
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }]
          }
          EOF

          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               ${{ secrets.DISCORD_WEBHOOK }}
